From adfc49717b87c65c1a43c73bd07eb37c35f5bd96 Mon Sep 17 00:00:00 2001
From: chentau <tchen1998@gmail.com>
Date: Sat, 30 Jan 2021 20:45:01 -0800
Subject: [PATCH 03/12] fix

---
 src/nvim/api/vim.c |  6 ++++--
 src/nvim/edit.c    | 10 ++++++++--
 2 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/src/nvim/api/vim.c b/src/nvim/api/vim.c
index d3b4aa5b0..7fd493ac9 100644
--- a/src/nvim/api/vim.c
+++ b/src/nvim/api/vim.c
@@ -2860,7 +2860,9 @@ error:
 ///                     Any text between startcol and the current
 ///                     cursor col is replaced by the completion.
 /// @param matches: A list of string matches.
-/// @param opts: Dictionary. No possible keys for now
+/// @param opts: Dictionary. Possible keys:
+///                 filterfunc: function used for filtering the
+///                     matches. See |nvim_register_filterfunc|.
 //
 // todo: completefunc with refresh: always
 // todo: figure out what to do with ctrl_e and ctrl_l
@@ -2935,7 +2937,7 @@ error:
 ///
 /// Register a lua function for filtering completion matches.
 /// The function must take in two arguments: the prefix (the
-/// currently typed text), and the text for a completion entry, and 
+/// currently typed text), and the text for a completion entry, and
 /// returns a float. Higher return values imply a better match, and a
 /// return value of 0 removes the entry from being shown.
 /// To remove the currently registered function, call the function
diff --git a/src/nvim/edit.c b/src/nvim/edit.c
index 4dc6f0ad5..99fa414c5 100644
--- a/src/nvim/edit.c
+++ b/src/nvim/edit.c
@@ -2775,7 +2775,7 @@ static void sort_completions(int num_items, compl_score_T *scores)
 
   qsort(scores, num_items, sizeof(compl_score_T), compare_scores);
 
-  // TODO(chentau): We don;t need to sort the entire linked
+  // TODO(chentau): We don't need to sort the entire linked
   // list; we just need to sort the first compl_match_arraysize entries,
   // since only those will be shown in the pum.
   for (i = 1; i < num_items; ++i) {
@@ -2808,6 +2808,7 @@ int set_compl_match_array(void)
   bool shown_match_ok = false;
   int lead_len;
   int i = 0;
+  int j = 0;
   int cur = -1;
 
   compl_match_arraysize = 0;
@@ -2865,11 +2866,15 @@ int set_compl_match_array(void)
     shown_match_ok = true;
   }
 
+  // i keeps track of which entry of compl_match_array we are at,
+  // while j keeps track of which entry of the completion linked list
+  // we are at.
   i = 0;
+  j = 0;
   compl = compl_first_match;
   do {
     if ((compl->cp_flags & CP_ORIGINAL_TEXT) == 0
-        && (scores[i].score)) {
+        && (scores[j].score)) {
       if (!shown_match_ok) {
         if (compl == compl_shown_match || did_find_shown_match) {
           // This item is the shown match or this is the
@@ -2919,6 +2924,7 @@ int set_compl_match_array(void)
         shown_match_ok = true;
       }
     }
+    j++;
     compl = compl->cp_next;
   } while (compl != NULL && compl != compl_first_match);
   if (!shown_match_ok) { // no displayed match at all
-- 
2.30.1

